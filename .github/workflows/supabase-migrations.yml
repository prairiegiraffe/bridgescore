name: Deploy Supabase Migrations

# DISABLED: Migrations are applied manually via Supabase SQL Editor
# To re-enable, uncomment the 'on:' section below

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'supabase/migrations/**'
#       - 'supabase/seed/**'
#   workflow_dispatch: # Allow manual trigger

on: [] # Disabled

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Run database migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Run seed data (if new migration)
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || git diff --name-only HEAD~1 HEAD | grep -q "supabase/migrations/.*pivots"; then
            echo "Running pivot seed data..."
            supabase db remote commit
            psql "${{ secrets.SUPABASE_DB_URL }}" -f supabase/seed/pivots.sql || echo "Seed already applied or failed"
          fi

      - name: Verify migration status
        run: supabase migration list --linked
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}